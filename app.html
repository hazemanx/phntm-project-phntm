<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHNTM Music App</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#800080">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PHNTM Music App">
    <link rel="apple-touch-icon" href="images/phntm-icon.png">
</head>
<body>
    <div class="container">
        <div class="album-art-container">
            <img src="images/album-art.jpg" alt="Album Art" class="album-art">
        </div>
        <div class="waveform"></div>
        <div class="playback-controls">
            <button id="prevBtn" class="button"><img src="images/prev-icon.png" alt="Previous"></button>
            <button id="playPauseBtn" class="button"><img src="images/play-icon.png" alt="Play"></button>
            <button id="nextBtn" class="button"><img src="images/next-icon.png" alt="Next"></button>
        </div>
        <div class="controls">
            <label for="speedControl">Speed:</label>
            <input type="range" id="speedControl" min="0.5" max="2" value="1" step="0.1">
            <label for="pitchControl">Pitch:</label>
            <input type="range" id="pitchControl" min="-1" max="1" value="0" step="0.1">
        </div>
        <input type="file" id="filePicker" accept="audio/*" style="display: none;">
        <button id="filePickerBtn" class="button">Choose Local Music</button>
    </div>

    <script src="js/howler.min.js"></script>
    <script>
        let sound;
        const playlist = [];
        let currentTrackIndex = 0;
        let playbackRate = 1;
        let pitch = 0;

        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const speedControl = document.getElementById('speedControl');
        const pitchControl = document.getElementById('pitchControl');
        const filePicker = document.getElementById('filePicker');
        const filePickerBtn = document.getElementById('filePickerBtn');

        playPauseBtn.addEventListener('click', function() {
            if (sound && sound.playing()) {
                sound.pause();
                playPauseBtn.querySelector('img').src = 'images/play-icon.png';
            } else if (sound) {
                sound.play();
                playPauseBtn.querySelector('img').src = 'images/pause-icon.png';
            } else if (playlist.length > 0) {
                loadTrack(playlist[currentTrackIndex]);
                sound.play();
                playPauseBtn.querySelector('img').src = 'images/pause-icon.png';
            }
        });

        prevBtn.addEventListener('click', function() {
            previousTrack();
        });

        nextBtn.addEventListener('click', function() {
            nextTrack();
        });

        speedControl.addEventListener('input', function() {
            playbackRate = parseFloat(this.value);
            if (sound) {
                sound.rate(playbackRate);
            }
        });

        pitchControl.addEventListener('input', function() {
            pitch = parseFloat(this.value);
            if (sound) {
                sound.rate(playbackRate + pitch);
            }
        });

        filePickerBtn.addEventListener('click', function() {
            filePicker.click();
        });

        filePicker.addEventListener('change', function(event) {
            const files = event.target.files;
            if (files.length > 0) {
                const fileURL = URL.createObjectURL(files[0]);
                playlist.push(fileURL);
                currentTrackIndex = playlist.length - 1;
                loadTrack(fileURL);
            }
        });

        function loadTrack(src) {
            if (sound) sound.unload();
            sound = new Howl({
                src: [src],
                html5: true,
                rate: playbackRate + pitch,
                onend: function() {
                    nextTrack();
                }
            });
        }

        function nextTrack() {
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            loadTrack(playlist[currentTrackIndex]);
            sound.play();
            playPauseBtn.querySelector('img').src = 'images/pause-icon.png';
        }

        function previousTrack() {
            currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            loadTrack(playlist[currentTrackIndex]);
            sound.play();
            playPauseBtn.querySelector('img').src = 'images/pause-icon.png';
        }

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
